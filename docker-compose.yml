version: '3.8'

services:
  postgres:
    image: postgres:16-alpine
    container_name: eywa-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: eywa
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - eywa-network

  eywa:
    image: neyho/eywa:latest
    container_name: eywa-core
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database configuration (using EYWA's expected env var names)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: eywa
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: eywa
      # Admin database (for creating the eywa database)
      POSTGRES_ADMIN_DB: postgres
      POSTGRES_ADMIN_USER: postgres
      POSTGRES_ADMIN_PASSWORD: eywa

      # EYWA configuration
      EYWA_HOME: /data/eywa
      EYWA_LOG_LEVEL: INFO
      EYWA_IAM_ENFORCE_ACCESS: "true"
      EYWA_SERVE: /opt/web
      EYWA_SERVER_HOST: 0.0.0.0
      EYWA_SERVER_PORT: 8080

      # OAuth configuration
      EYWA_OAUTH_PERSISTENCE: "true"
      EYWA_IAM_ALLOWED_REDIRECTIONS: "http://localhost:8080/eywa/callback,http://localhost:8080/eywa/silent-callback"
      EYWA_IAM_ALLOWED_LOGOUTS: "http://localhost:8080/eywa"

      # Admin user (demo defaults - CHANGE FOR PRODUCTION!)
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin

      # Encryption (demo key - CHANGE FOR PRODUCTION!)
      # ENCRYPTION_KEY: your-secure-encryption-key-here

      # Java options
      JAVA_OPTS: "-Xmx2g -Xms512m"
    ports:
      - "8080:8080"
    volumes:
      - eywa_data:/data/eywa
    networks:
      - eywa-network
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  eywa_data:
    driver: local

networks:
  eywa-network:
    driver: bridge
